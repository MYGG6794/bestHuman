using System;
using System.Drawing;
using System.Windows.Forms;
using System.Drawing.Imaging;
using System.Runtime.InteropServices;
using Microsoft.Web.WebView2.Core;
using Microsoft.Web.WebView2.WinForms;
using System.Threading.Tasks;

namespace CoreApplication
{
    public class DigitalHumanDisplay : Panel
    {
        private Color _chromaKeyColor = Color.Green; // é»˜è®¤æŠ åƒé¢œè‰²ä¸ºç»¿è‰²
        private int _tolerance = 30; // é»˜è®¤é¢œè‰²å®¹å·®
        private bool _enableChromaKey = false; // é»˜è®¤ç¦ç”¨æŠ åƒåŠŸèƒ½ï¼Œé¿å…å½±å“æ€§èƒ½
        private WebView2? _webView;
        private string? _streamUrl;

        [System.ComponentModel.Browsable(false)]
        [System.ComponentModel.DesignerSerializationVisibility(System.ComponentModel.DesignerSerializationVisibility.Hidden)]
        public bool EnableChromaKey
        {
            get { return _enableChromaKey; }
            set { _enableChromaKey = value; }
        }

        [System.ComponentModel.Browsable(false)]
        [System.ComponentModel.DesignerSerializationVisibility(System.ComponentModel.DesignerSerializationVisibility.Hidden)]
        public Color ChromaKeyColor
        {
            get { return _chromaKeyColor; }
            set { _chromaKeyColor = value; Invalidate(); }
        }

        [System.ComponentModel.Browsable(false)]
        [System.ComponentModel.DesignerSerializationVisibility(System.ComponentModel.DesignerSerializationVisibility.Hidden)]
        public int Tolerance
        {
            get { return _tolerance; }
            set { _tolerance = value; Invalidate(); }
        }

        public DigitalHumanDisplay()
        {
            DoubleBuffered = true; // å¯ç”¨åŒç¼“å†²ï¼Œå‡å°‘é—ªçƒ
            SetStyle(ControlStyles.SupportsTransparentBackColor | 
                    ControlStyles.AllPaintingInWmPaint | 
                    ControlStyles.UserPaint, true);
            
            // å…³é”®ä¿®å¤ï¼šæ§ä»¶å§‹ç»ˆä¿æŒé€æ˜ï¼Œè®©ä¸»çª—å£çš„é€æ˜ç”Ÿæ•ˆ
            BackColor = Color.Transparent;
            
            InitializeWebView();
        }

        private async void InitializeWebView()
        {
            try
            {
                // æ§ä»¶èƒŒæ™¯ä¿æŒé€æ˜ï¼Œä¸è®¾ç½®ä»»ä½•é¢œè‰²
                _webView = new WebView2
                {
                    Dock = DockStyle.Fill,
                    Size = this.Size,
                    Location = new Point(0, 0)
                };
                
                // WebView2èƒŒæ™¯è®¾ä¸ºé€æ˜
                _webView.DefaultBackgroundColor = Color.Transparent;
                
                Controls.Add(_webView);
                await _webView.EnsureCoreWebView2Async();

                // WebView2é…ç½®
                var settings = _webView.CoreWebView2.Settings;
                settings.IsWebMessageEnabled = true;
                settings.AreDefaultContextMenusEnabled = false;
                settings.IsStatusBarEnabled = false;
                
                Logger.LogInfo("WebView2é€æ˜èƒŒæ™¯é…ç½®å®Œæˆ");
                Logger.LogInfo("WebView2 åˆå§‹åŒ–å®Œæˆ");
            }
            catch (Exception ex)
            {
                Logger.LogError($"åˆå§‹åŒ–WebView2å¤±è´¥: {ex.Message}", ex);
            }
        }

        public void SetStreamUrl(string url)
        {
            _streamUrl = url;
            Logger.LogInfo($"è®¾ç½®æµURL: {url}");
            if (_webView?.CoreWebView2 != null)
            {
                try 
                {
                    _webView.CoreWebView2.Navigate(url);
                    Logger.LogInfo("æˆåŠŸå¯¼èˆªåˆ°æµURL");
                    
                    // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåå¯ç”¨è°ƒè¯•
                    _webView.CoreWebView2.NavigationCompleted += async (sender, args) =>
                    {
                        if (args.IsSuccess)
                        {
                            Logger.LogInfo("é¡µé¢å¯¼èˆªå®Œæˆï¼Œå¯ç”¨è°ƒè¯•æ¨¡å¼");
                            await Task.Delay(1000); // ç­‰å¾…é¡µé¢ç¨³å®š
                            await SetupWebView2DebuggingAsync();
                            
                            // å¦‚æœæŠ åƒå·²å¯ç”¨ï¼Œé‡æ–°åº”ç”¨
                            if (_enableChromaKey)
                            {
                                Logger.LogInfo("é¡µé¢åŠ è½½å®Œæˆï¼Œé‡æ–°åº”ç”¨æŠ åƒæ•ˆæœ");
                                await Task.Delay(500);
                                InjectChromaKeyScript(true);
                            }
                        }
                        else
                        {
                            Logger.LogError("é¡µé¢å¯¼èˆªå¤±è´¥");
                        }
                    };
                }
                catch (Exception ex)
                {
                    Logger.LogError($"å¯¼èˆªåˆ°æµURLå¤±è´¥: {ex.Message}", ex);
                }
            }
        }

        public void SetChromaKeyEnabled(bool enabled)
        {
            _enableChromaKey = enabled;
            Logger.LogInfo($"æŠ åƒåŠŸèƒ½å·²{(enabled ? "å¯ç”¨" : "ç¦ç”¨")}");
            
            // æ§ä»¶å§‹ç»ˆä¿æŒé€æ˜èƒŒæ™¯ï¼Œä¸è®¾ç½®ç»¿è‰²
            // æŠ åƒå¤„ç†å®Œå…¨åœ¨WebView2çš„JavaScriptä¸­å®Œæˆ
            
            if (_webView?.CoreWebView2 != null)
            {
                // æ³¨å…¥æŠ åƒå¤„ç†JavaScript
                InjectChromaKeyScript(enabled);
            }
            
            this.Invalidate();
        }

        private async void InjectChromaKeyScript(bool enabled)
        {
            if (_webView?.CoreWebView2 == null) return;
            
            try
            {
                string script;
                if (enabled)
                {
                    // ç®€åŒ–çš„æŠ åƒJavaScript - ç›´æ¥ä½¿ç”¨CSSå¤„ç†
                    script = @"
                        (function() {
                            console.log('ğŸ¯ å¼€å§‹ç®€åŒ–æŠ åƒå¤„ç†...');
                            
                            // æ¸…ç†ä¹‹å‰çš„å¤„ç†
                            const existingCanvas = document.getElementById('chroma-canvas');
                            if (existingCanvas) existingCanvas.remove();
                            
                            // æŸ¥æ‰¾è§†é¢‘å…ƒç´ 
                            const video = document.querySelector('video');
                            if (!video) {
                                console.log('âŒ æœªæ‰¾åˆ°è§†é¢‘å…ƒç´ ');
                                return;
                            }
                            
                            console.log('âœ… æ‰¾åˆ°è§†é¢‘å…ƒç´ ï¼Œå°ºå¯¸:', video.videoWidth + 'x' + video.videoHeight);
                            
                            // è®¾ç½®é¡µé¢å’Œè§†é¢‘èƒŒæ™¯é€æ˜
                            document.body.style.cssText = `
                                background: transparent !important;
                                background-color: transparent !important;
                            `;
                            
                            document.documentElement.style.cssText = `
                                background: transparent !important;
                                background-color: transparent !important;
                            `;
                            
                            // å°è¯•CSSæ»¤é•œå»é™¤ç»¿è‰²
                            video.style.cssText = `
                                background: transparent !important;
                            `;
                            
                            // æ³¨å…¥CSSæ ·å¼è®©ç»¿è‰²é€æ˜
                            const style = document.createElement('style');
                            style.textContent = `
                                body, html {
                                    background: transparent !important;
                                }
                                
                                video {
                                    background: transparent !important;
                                    /* å°è¯•CSSæŠ åƒæ»¤é•œ */
                                    filter: 
                                        drop-shadow(0 0 0 transparent) 
                                        contrast(1.1);
                                }
                                
                                /* è®©ç»¿è‰²å…ƒç´ é€æ˜ */
                                *[style*='rgb(0, 255, 0)'],
                                *[style*='#00ff00'],
                                *[style*='lime'],
                                *[style*='green'] {
                                    background: transparent !important;
                                    opacity: 0 !important;
                                }
                            `;
                            document.head.appendChild(style);
                            
                            console.log('âœ… CSSæŠ åƒå¤„ç†å·²åº”ç”¨');
                        })();
                    ";
                }
                else
                {
                    // ç¦ç”¨æŠ åƒï¼šæ¢å¤æ­£å¸¸æ˜¾ç¤º
                    script = @"
                        (function() {
                            const canvas = document.getElementById('chroma-canvas');
                            if (canvas) canvas.remove();
                            
                            const video = document.querySelector('video');
                            if (video) {
                                video.style.cssText = '';
                            }
                            
                            // ç§»é™¤æŠ åƒæ ·å¼
                            const styles = document.querySelectorAll('style');
                            styles.forEach(style => {
                                if (style.textContent.includes('CSSæŠ åƒ') || 
                                    style.textContent.includes('background: transparent')) {
                                    style.remove();
                                }
                            });
                            
                            console.log('âœ… æŠ åƒå¤„ç†å·²ç¦ç”¨');
                        })();
                    ";
                }
                
                await _webView.CoreWebView2.ExecuteScriptAsync(script);
                Logger.LogInfo($"æŠ åƒè„šæœ¬: {(enabled ? "å¯ç”¨" : "ç¦ç”¨")} - JavaScriptå¤„ç†å®Œæˆ");
            }
            catch (Exception ex)
            {
                Logger.LogError($"æ³¨å…¥æŠ åƒè„šæœ¬å¤±è´¥: {ex.Message}", ex);
            }
        }

        private async Task SetupWebView2DebuggingAsync()
        {
            if (_webView?.CoreWebView2 == null) return;
            
            try
            {
                // æ³¨å…¥è°ƒè¯•è„šæœ¬
                string debugScript = @"
                    // æ·»åŠ è°ƒè¯•åŠŸèƒ½
                    console.log('WebView2 è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
                    
                    // ç›‘å¬é¡µé¢é”™è¯¯
                    window.addEventListener('error', function(e) {
                        console.error('é¡µé¢é”™è¯¯:', e.message, e.filename, e.lineno);
                    });
                    
                    // ç›‘å¬DOMå˜åŒ–
                    if (typeof MutationObserver !== 'undefined') {
                        const observer = new MutationObserver(function(mutations) {
                            mutations.forEach(function(mutation) {
                                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                                    console.log('DOMå…ƒç´ å·²æ·»åŠ :', mutation.addedNodes);
                                }
                            });
                        });
                        observer.observe(document.body, { childList: true, subtree: true });
                    }
                ";
                
                await _webView.CoreWebView2.ExecuteScriptAsync(debugScript);
                Logger.LogInfo("WebView2è°ƒè¯•è„šæœ¬å·²æ³¨å…¥");
            }
            catch (Exception ex)
            {
                Logger.LogError($"è®¾ç½®WebView2è°ƒè¯•å¤±è´¥: {ex.Message}", ex);
            }
        }

        // é‡å†™Paintæ–¹æ³•ï¼Œç¡®ä¿é€æ˜æ•ˆæœ
        protected override void OnPaint(PaintEventArgs e)
        {
            // ä¸ç»˜åˆ¶ä»»ä½•èƒŒæ™¯ï¼Œä¿æŒå®Œå…¨é€æ˜
            // base.OnPaint(e); ä¸è°ƒç”¨åŸºç±»ç»˜åˆ¶
        }

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                this.BackgroundImage?.Dispose();
                _webView?.Dispose();
            }
            base.Dispose(disposing);
        }
    }
}
